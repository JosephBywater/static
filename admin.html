<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MC-API &middot; Admin</title>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/style/styles.css">
    <link rel="stylesheet" type="text/css" href="/style/flags.css">
    <link rel="shortcut icon" href="//raw.githubusercontent.com/MC-API/static/master/assets/favicon.ico"/>
</head>
<body>
<div class="container card">
    <div class="content">
        <h2><i class="fa fa-code"></i> MC-API <small>Admin &bull; #REGION# &middot; #SERVERID# #FLAG#</small>
            <span class="pull-right">
                <button class="btn btn-warning" data-action="flush_hitqueue" data-action-data=""><i class="fa fa-bolt"></i> Flush Queue</button>
                <button class="btn btn-danger" data-action="clear_local" data-action-data="target=*"><i class="fa fa-trash-o"></i> Clear Local Cache</button>
                <button class="btn btn-danger" data-action="clear_access"><i class="fa fa-warning"></i> Clear Access Tokens</button>
            </span>
        </h2>
        <hr>

        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading" style="background-color:#E84938; color:white">
                        <h3 class="panel-title">Redis <span id="redismemoryusage"></span></h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered table-striped" id="redis-hits">
                                    <tbody>
                                        <tr>
                                            <td>Route</td>
                                            <td>Hits</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered table-striped" id="redis-stats">
                                    <tbody>
                                        <tr>
                                            <td>Cache</td>
                                            <td>Size</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <p><strong>Total Hits:</strong> <span id="totalredishits">0</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading" style="background-color:#3ECC3C; color:white">
                        <h3 class="panel-title">Memory <span id="memoryusage"></span></h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered table-striped" id="memory-hits">
                                    <tbody>
                                        <tr>
                                            <td>Route</td>
                                            <td>Hits</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered table-striped" id="memory-stats">
                                    <tbody>
                                        <tr>
                                            <td>Cache</td>
                                            <td>Size</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading" style="background-color:#EAA053; color:white">
                        <h3 class="panel-title">External</h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>CloudFlare (Last Month) <small id="cf-source"></small></h5>
                                <div id="cloudflare-data"><div class="text-center"><i class="fa fa-refresh fa-spin fa-3x"></i></div></div>
                            </div>
                            <div class="col-md-3">
                                <h5>Bugsnag <small id="bugsnag-source"></small></h5>
                                <div id="bugsnag-data"><div class="text-center"><i class="fa fa-refresh fa-spin fa-3x"></i></div></div>
                            </div>
                            <div class="col-md-3">
                                <h5>Mongo <small id="mongo-source"></small></h5>
                                <div id="mongo-data"><div class="text-center"><i class="fa fa-refresh fa-spin fa-3x"></i></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <footer>
        <ul class="nav nav-pills">
            <li class="text-muted disclaimer">MC-API is not affiliated with Mojang AB, Microsoft or Minecraft.net</li>
            <li class="pull-right">
                <a>&copy; #YEAR# mc-api.net</a>
            </li>
        </ul>
    </footer>
    </div>
    <br>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="//cdn.rawgit.com/avoidwork/filesize.js/master/lib/filesize.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
    <script type="text/javascript">
        var _aid = '#AID#';
        var api = '#APIPATH#';
        console.log('Access key: ' + _aid);

        // TODO handle errors for ajax
        $(document).ready(function() {
            updateStats();
            loadExternal();

            setInterval(updateStats, 1000 * 20);
        });

        $('button[data-action]').on('click', function(e) {
            e.preventDefault();

            $.ajax({
                url: api + '/' + $(this).attr('data-action') + '?_aid=' + _aid,
                type: 'get',
                data: $(this).attr('data-action-data'),
                success: function(resp) {
                    console.log(resp);

                    if(resp.status == 200) {
                        alert(resp.message);
                        if(resp.refresh) {
                            window.location.reload();
                        } else {
                            updateStats();
                        }
                    } else {
                        alert(resp.error);
                    }
                }
            });
            

            return false;
        });

        function loadExternal() {
            // cloudflare
            $.ajax({
                type: 'get',
                url: api + '/cf?_aid=' + _aid,
                success: function(resp) {
                    if(resp.source) {
                        $('#cf-source').html('from <span ' + (resp.source == 'icache' ? 'title="Internal cache"' : 'title="Direct"') + '>' + resp.source + '</span>');
                    }
                    
                    if(resp.result) {
                        var s = "";
                        s = s + '<p><strong>Requests</strong> ' + numeral(resp.result.totals.requests.all).format('0,0') + '</p>';
                        s = s + '<p><strong>Bandwidth:</strong> ' + filesize(resp.result.totals.bandwidth.all) + '</p>';
                        s = s + '<p><strong>Threats:</strong> ' + numeral(resp.result.totals.threats.all).format('0,0') + '</p>';
                        s = s + '<p><strong>JSON Requests:</strong> ' + numeral(resp.result.totals.requests.content_type.json).format('0,0') + ' &bull; <strong>JSON Bandwidth:</strong> ' + filesize(resp.result.totals.bandwidth.content_type.json) + '</p>';
                        s = s + '<p><strong>PNG Requests:</strong> ' + numeral(resp.result.totals.requests.content_type.png).format('0,0') + ' &bull; <strong>PNG Bandwidth:</strong> ' + filesize(resp.result.totals.bandwidth.content_type.png) + '</p>';
                        s = s + '<p><strong>SSL Requests:</strong> ' + numeral(resp.result.totals.requests.ssl.encrypted).format('0,0') + '</p>';

                        $('#cloudflare-data').html(s);
                    }
                }
            });

            // bugsnag
            $.ajax({
                type: 'get',
                url: api + '/bugsnag?_aid=' + _aid,
                success: function(resp) {
                    if(resp.source) {
                        $('#bugsnag-source').html('from ' + resp.source);
                    }
                    if(resp.errors && resp.release_stages && resp.name && resp.html_url) {
                        $('#bugsnag-data').html('<strong>' + resp.name + '</strong> has ' + numeral(resp.errors).format('0,0') + ' error' + (resp.errors == 1 ? '' : 's') + ' <a target="_blank" href="' + resp.html_url + '">Learn more.</a>');
                    }
                }
            });
        }

        function updateStats() {
            $.ajax({
                type: 'get',
                url: api + '/stats?_aid=' + _aid,
                success: function(resp) {
                    // console.log(resp);
                    $('#memoryusage').html('(' + filesize(resp.info.memory) + ')');
                    $('#redismemoryusage').html('(' + filesize(resp.info.redis_memory) + ')');
                    $('#totalredishits').html(numeral(resp.caches.redis.hits_total).format('0,0'));

                    $.each(resp.caches.redis.hits, function(route, el) {
                        var ele = $('#redis-hit-' + route.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-'));
                        if(ele.length) {
                            ele.html('<td><code>' + route + '</code></td><td>' + numeral(el).format('0,0') + '</td>');
                        } else {
                            $('#redis-hits tr:last').after('<tr class="redis-hit" id="redis-hit-' + route.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-') + '"><td><code>' + route + '</code></td><td>' + numeral(el).format('0,0') + '</td></tr>');
                        }
                    });
                    $.each(resp.caches.redis.size, function(name, el) {
                        var ele = $('#redis-stat-' + name.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-'));
                        if(ele.length) {
                            ele.html('<td><code>' + name + '</code></td><td>' + numeral(el).format('0,0') + '</td>');
                        } else {
                            $('#redis-stats tr:last').after('<tr class="redis-stat" id="redis-stat-' + name.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-') + '"><td><code>' + name + '</code></td><td>' + numeral(el).format('0,0') + '</td></tr>');
                        }
                    });

                    $.each(resp.caches.memory.hits, function(route, el) {
                        var ele = $('#memory-hit-' + route.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-'));
                        if(ele.length) {
                            ele.html('<td><code>' + route + '</code></td><td>' + numeral(el).format('0,0') + '</td>');
                        } else {
                            $('#memory-hits tr:last').after('<tr class="memory-hit" id="memory-hit-' + route.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-') + '"><td><code>' + route + '</code></td><td>' + numeral(el).format('0,0') + '</td></tr>');
                        }
                    });
                    $.each(resp.caches.memory.size, function(name, el) {
                        var ele = $('#memory-stat-' + name.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-'));
                        if(ele.length) {
                            ele.html('<td><code>' + name + '</code></td><td>' + numeral(el).format('0,0') + '</td>');
                        } else {
                            $('#memory-stats tr:last').after('<tr class="memory-stat" id="memory-stat-' + name.replace(/\//g, '-').replace(/\:/g, '-').replace(/ /g, '-') + '"><td><code>' + name + '</code></td><td>' + numeral(el).format('0,0') + '</td></tr>');
                        }
                    });
                }
            });
    
            return 'ok';
        }
    </script>
</body>
</html>
